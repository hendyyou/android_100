package cn.digione.yibaic.shop.ui;import android.os.Bundle;import android.text.Editable;import android.text.SpannableStringBuilder;import android.text.TextUtils;import android.text.style.TextAppearanceSpan;import android.view.KeyEvent;import android.view.LayoutInflater;import android.view.View;import android.view.ViewGroup;import android.widget.EditText;import android.widget.TextView;import cn.digione.yibaic.shop.R;import cn.digione.yibaic.shop.bean.JsonNoneOutBean;import cn.digione.yibaic.shop.common.Constants;import cn.digione.yibaic.shop.http.CustomerJsonHttpResponseHandler;import cn.digione.yibaic.shop.http.HttpClient;import cn.digione.yibaic.shop.util.Log;import cn.digione.yibaic.shop.util.Utils;import cn.digione.yibaic.shop.widget.BaseAlertDialog;import com.loopj.android.http.RequestParams;/** * Created with IntelliJ IDEA. * User: youzh * Date: 14-3-4 * Time: 下午5:41 */public class RegisterPasswordFragment extends StepsFragment {    private static final String ACTION_REG_SMS_SENT = "cn.100jia.shop.action.REG_SMS_SENT";    private static final int ERROR_NETWORK = 1;    private static final int ERROR_PHONE_NULL = 4;    private static final int ERROR_SEND_SMS_FAIL = 3;    private static final int ERROR_SERVER = 2;    private static final int ROLL_SMS_SEND_TIMEOUT = 10;    private int accountType;    private EditText mPasswordConfirmView;    private EditText mPasswordView;    private String register;    private SpannableStringBuilder getErrorSpanString(int i) {        String s = getActivity().getString(i);        TextAppearanceSpan textSpan = new TextAppearanceSpan(getActivity(), R.style.TextAppearance_Notice_Normal);        SpannableStringBuilder spanBuilder = new SpannableStringBuilder(s);        spanBuilder.setSpan(textSpan, spanBuilder.length() - s.length(), spanBuilder.length(), 33);        return spanBuilder;    }    /**     * 获取密码字符满足的规则数组     *     * @param passwordWithinChars     *            规则数组     * @param passwordChar     *            密码字符     * @return 规则数组     */    private static char[] getPasswordWithinRuleChar(char[] passwordWithinChars, char passwordChar) {        if ((passwordChar >= 'A' && passwordChar <= 'Z') || (passwordChar >= 'a' && passwordChar <= 'z')) {            // 第一位为1时必须包含一个字母（A-Z）（a-z）            // A-Z 41-5A            // a-z 61-7A            passwordWithinChars[0] = '1';        } else if (passwordChar >= '0' && passwordChar <= '9') {            // 第二位为1时必须包含一个数字字符（0-9）            // 0-9 30-39            passwordWithinChars[1] = '1';        } else if ((passwordChar >= '!' && passwordChar <= '/') || (passwordChar >= ':' && passwordChar <= '@')                   || (passwordChar >= '[' && passwordChar <= '`') || (passwordChar >= '{' && passwordChar <= '~')) {            // 第三位为1时必须包含特殊字符            // !"#$%&'()*+,-./ 20-2F            // :;<=>?@ 3A-40            // [\]^_` 5B-60            // {|}~ 7B-7E            passwordWithinChars[2] = '1';        }        return passwordWithinChars;    }    /**     * 获取密码满足的规则数组     *     * @param password     *            密码字符串     * @return 规则数组     */    private static boolean checkPasswordRule(String password) {        char[] passwordWithinChars = { '0', '0', '0' };        char[] passwordChars = password.toCharArray();        for (char passwordChar : passwordChars) {            passwordWithinChars = getPasswordWithinRuleChar(passwordWithinChars, passwordChar);        }        String passwordRule = new String(passwordWithinChars);        return passwordRule.equals("110") || passwordRule.equals("111");    }    public static boolean checkPasswordPattern(String password) {        if (password != null) {            int len = password.length();            if (len >= 8 && len <= 16) {                return checkPasswordRule(password);            }        }        return true;    }    private String checkAndGetPassword() {        Editable passwordEditable = mPasswordView.getText();        if (null == passwordEditable || TextUtils.isEmpty(passwordEditable.toString())) {            mPasswordView.setError(getErrorSpanString(R.string.error_empty_pwd));            mPasswordView.requestFocus();            return null;        }        String password = passwordEditable.toString();        if (!checkPasswordPattern(password)) {            mPasswordView.setError(getErrorSpanString(R.string.error_illegal_pwd));            mPasswordView.requestFocus();            return null;        }        Editable passwordConfirmEditable = mPasswordConfirmView.getText();        if (null == passwordConfirmEditable || !password.equals(passwordConfirmEditable.toString())) {            mPasswordConfirmView.setError(getErrorSpanString(R.string.password_error_inconsistent));            mPasswordView.requestFocus();            return null;        }        return password;    }    public String getPassword() {        Editable passwordEditable = mPasswordView.getText();        if (null != passwordEditable) {            return passwordEditable.toString();        }        return null;    }    protected void onButtonNextClicked() {        final String password = checkAndGetPassword();        if (TextUtils.isEmpty(password)) {            Log.w("no argument found");            return;        }        if (Constants.ArgValue.AccountType.PHONE == accountType) {            Utils.SoftInput.hide(getActivity(), getView().getWindowToken());            BaseAlertDialog baseAlertDialog = new BaseAlertDialog(getActivity());            baseAlertDialog.setMessage(R.string.val_sms_alert);            baseAlertDialog.setNegativeButton(R.string.btn_negative, null);            baseAlertDialog.setPositiveButton(R.string.btn_positive, new android.view.View.OnClickListener() {                public void onClick(View view) {                    HttpClient httpClient = HttpClient.getInstall(getActivity());                    RequestParams params = new RequestParams();                    params.put(Constants.ArgName.Request.Register.USER_VO_MOBILE, register);                    params.put(Constants.ArgName.Request.Register.USER_VO_PASSWORD, password);                    httpClient                            .postAsync(Constants.NetWorkRequest.REGISTER_URL_009, params, mCustomerJsonHttpResponseHandler);                }            });            baseAlertDialog.show();        } else if (Constants.ArgValue.AccountType.EMAIL == accountType) {            Utils.SoftInput.hide(getActivity(), getView().getWindowToken());            HttpClient httpClient = HttpClient.getInstall(getActivity());            RequestParams params = new RequestParams();            params.put(Constants.ArgName.Request.Register.USER_VO_EMAIL, register);            params.put(Constants.ArgName.Request.Register.USER_VO_PASSWORD, password);            httpClient.postAsync(Constants.NetWorkRequest.REGISTER_URL_009, params, mCustomerJsonHttpResponseHandler);        }    }    public View onCreateView(LayoutInflater layoutinflater, ViewGroup viewgroup, Bundle bundle) {		super.onCreateView(layoutinflater, viewgroup, bundle);        View view = layoutinflater.inflate(R.layout.register_input_password, viewgroup, false);        if (null == view) {            return null;        }        mPasswordView = (EditText) view.findViewById(R.id.ev_password);        mPasswordConfirmView = (EditText) view.findViewById(R.id.ev_password_confirm);        mPasswordConfirmView.setOnEditorActionListener(new android.widget.TextView.OnEditorActionListener() {            public boolean onEditorAction(TextView textview, int i, KeyEvent keyevent) {                if (i == 5) {                    triggerNextStep();                    return true;                }                return false;            }        });        mPasswordView.requestFocus();        mPasswordView.setOnFocusChangeListener(new android.view.View.OnFocusChangeListener() {            public void onFocusChange(View view1, boolean flag) {                if (!flag) {                    String s = getPassword();                    if (TextUtils.isEmpty(s)) {                        mPasswordView.setError(getErrorSpanString(R.string.error_empty_pwd));                    } else if (!checkPasswordPattern(s)) {                        mPasswordView.setError(getErrorSpanString(R.string.error_illegal_pwd));                    }                }            }        });        super.isUpdateShopCartData = false;        accountType = getArguments().getInt(Constants.ArgName.UI.RegisterPassword.ACCOUNT_TYPE);        register = getArguments().getString(Constants.ArgName.UI.RegisterPassword.REGISTER);        mCustomerJsonHttpResponseHandler = new CustomerJsonHttpResponseHandler<JsonNoneOutBean>(getActivity()) {            @Override            public void processCallSuccess(JsonNoneOutBean outBean, String msg) {                if (Constants.ArgValue.AccountType.PHONE == accountType) {                    RegisterSmsSentFragment registersmssentfragment = new RegisterSmsSentFragment();                    Bundle bundle = new Bundle();                    bundle.putInt(Constants.ArgName.UI.RegisterSmsSent.TITLE_NAME, R.string.title_activate);                    registersmssentfragment.setArguments(bundle);                    replaceToFragment(registersmssentfragment, true);                    getActivity().setResult(-1);                } else if (Constants.ArgValue.AccountType.EMAIL == accountType) {                    Utils.SoftInput.hide(getActivity(), getView().getWindowToken());                    RegisterEmailSentFragment registeremailsentfragment = new RegisterEmailSentFragment();                    Bundle bundle1 = new Bundle();                    bundle1.putString(Constants.ArgName.UI.RegisterPassword.REGISTER, register);                    bundle1.putInt(Constants.ArgName.UI.RegisterSmsSent.TITLE_NAME, R.string.title_activate);                    registeremailsentfragment.setArguments(bundle1);                    replaceToFragment(registeremailsentfragment, true);                    getActivity().setResult(-1);                }            }        };        return view;    }    public void onResume() {        super.onResume();        displaySoftInputIfNeed(mPasswordView, true);    }}